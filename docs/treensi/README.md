# TreeNSI – пример системы нормативно-справочной информации предприятия

## Описание

Система содержит основные справочники, участвующие и описывающие бизнес-процессы предприятия: справочник Страны и территории мира, Валюты, Контрагенты, Структура предприятия, Номенклатура материальных ценностей, товаров и услуг. Система также содержит вариант организации хранения информации об адресах контрагентов;  данные ОСЖД (Организация сотрудничества железных дорог); вариант организации хранения и использования составных справочников – справочников, представляющих  данные разных справочников как единую новую сущность.

Система TreeNSI – пример реализации НСИ предприятия с возможностью ее интеграции в уже имеющуюся информационную среду предприятия с возможностью "плавного" долговременного перехода эксплуатирующийся систем на предложенные системой данные.

Структура TreeNSI построена на примере работы реальных организаций Республики Беларусь различного рода деятельности, при ее проектировании активно использовались нормативные данные РБ, однако данная структура (при минимальных доработках) может быть легко адаптирована для предприятий любых стран постсоветского пространства.

Следует отметить, что название системы `TreeNSI` отражает в себе как основной принцип построения данных (древовидные справочники), так и отголосок систем управления предприятия, разработанных в конце прошлого века на постсоветском пространстве, которые, как не удивительно, еще продолжают, так или иначе, использоваться по сей день. TreeNSI собственно и проектировалось с целью перехода с типов данных и принципов построения бизнес-логики, заложенных в конце прошлого века, к современным технологиям разработки (более подробно этот вопрос освещен в разделе ["Так исторически сложилось"](/so-historically/)).

В разработке TreeNSI использовался анализ не только реально бывших в эксплуатации `"армов"` и программ АСУ, написанных на `Pascal`, `FoxPro`, `Clipper`, но так же и современных ERP систем, предлагаемых на рынке: `1С-Предприятие`, `Галактика`, `SAP`.

TreeNSI не является эталоном организации НСИ предприятия. Прежде всего, это пример ее возможной реализации, дабы разработчики, столкнувшиеся с вопросом реорганизации структуры основных справочных данных, могли посмотреть на задачу с другой стороны, сравнить предложенные  решения со своими наработками, что, возможно, позволит избежать досадных ошибок проектирования и сэкономит время разработки.

Пример реализации и `SQL-скрипты` для ввода первичной информации можно посмотреть [здесь](https://github.com/zloyAltr/TreeNSI).

## Задачи современного НСИ

Основные задачи, стоящие перед НСИ предприятия

1. Достоверность информации.
2. Актуальность информации вне зависимости от времени ее использования.
3. Однозначность данных (отсутствие задвоенных данных).
4. Простота использования в задачах.
5. Интуитивно понятный пользователю интерфейс.

## Принципы построения системы

Система НСИ TreeNSI представляет собой набор объектов СУБД `MS SQL server (>=2008)`. Пользовательский интерфейс может быть реализован на любой технологии.
Выбор в качестве СУБД `MS SQL` объясняется тем, что данная СУБД не только является надежным источником хранения информации, но и предоставляет большой набор удобных и быстрых инструментов манипуляции данными: представления, триггеры, `T-SQL`. Так как `TreeNSI` создавалась с целью последовательного внедрения в уже существующею информационную систему предприятия, то местом размещения основной бизнес-логики была выбрана сама база данных. Это позволило без наличия пользовательского интерфейса проводить тестирование новых структур с учетом уже имеющихся данных, сравнивать производительность выборки данных с уже эксплуатируемыми таблицами.
Для ускорения работы с данными и рационального использования трафика и памяти сервера, свойства каждого справочника разделены по отдельным таблицам по мере частоты их использования в реальных задачах. Наиважнейшие и неизменные свойства, используемые  постоянно, содержатся в таблице вместе с автоинкрементным ключом, тогда редко используемые свойства сгруппированы и размещены в отдельных таблицах. Это позволяет уменьшить объемы передаваемых по умолчанию данных. Соответственно, для получения подробных данных должны использоваться уточняющие запросы.
Для наглядности в пользовательском интерфейсе должны использоваться представления (`view`) справочников. Используя серверную оптимизацию запросов намного выгоднее "собрать" необходимые данные из всех таблиц, описывающих справочник, и выдать уже готовый набор информации пользователю, чем перенести на клиент данные со всех таблиц и сборку произвести уже на клиенте.
Представления также позволяют повторить набор полей источников данных для уже эксплуатирующихся программ, что позволит быстрее осуществить переход на новое НСИ.

Схематично принцип работы TreeNSI можно представить так:

Пользователем вводятся новые данные. Наилучшим способом ввода новых данных видится использование хранимых процедур `T-SQL`. Подобные процедуры вводят тот минимум основных данных, которые характеризуют объект. Перед записью процедуры осуществят проверку вносимых данных (в том числе и на дублирование), произведет дополнительные операции по регистрации, проверки прав пользователя. В случае попытки ввода неверной информации, пользователю вернется сообщение об ошибке.

::: tip
Используя хранимые процедуры можно осуществлять ввод данных и из других задач. Подобный `SQL API` легок в проектировании и внедрении.
:::

При необходимости, пользователь может внести дополнительные данные. Если же этого не сделано, то дополнить новый элемент дополнительной информации должен ответственный пользователь.

::: tip
Следует отметить, что роль пользователя, который корректирует внесенную информацию, очень велика. Если правом на создание нового элемента могут обладать многие, то административные правами (в том числе право на удаление элемента) должны обладать ограниченный круг адекватных пользователей. Именно они будут проводить администрирование НСИ, менять структуру подчиненности элементов, актуализировать значение реквизитов. Без этих пользователей НСИ превратится просто в кучу данных, и никакая проверка на дублирование тут не поможет.
:::

Сразу же после создания, новый элемент готов к использованию. Для пользовательского интерфейса выбора значений из справочника, для использования в качестве источника данных для других задач информационной системы используются представления или табличные функции. Они обеспечивают высокую скорость и компактность выдаваемой информации. Благодаря этому любое измерение данных, произведенное пользователем, тут же отражается в представлении, причем не важно, использует ли задача тот же сервер что и НСИ или нет.

Если необходимо на клиентской стороне оперативно реагировать на изменения данных, то в этом может помочь система логирования, построенная на `тригерах`.

::: tip
Срабатывание тригеров на измерение данных в таблицах записывают информацию об изменении в общий для БД журнал изменений (есть много решений подобного логирования, например <https://github.com/DKlenye/SqlChangeDataLog>).
:::

Каждый клиент может периодически обращаться к журналу изменений, контролируя интересующие его таблицы. Появление новой записи в журнале изменений вызывает на клиенте соответствующее событие.

::: tip
К недостатком данного метода можно отнести тот факт, что к журналу измерений, а он будет постоянно расти, будет обращаться каждый клиент, что повышает нагрузку на `SQL сервер`.
:::

Другой вариант подразумевает организацию `web-сервиса`, который представляет своим подписчикам (клиентам НСИ) рассылку о последних изменениях в базе данных `TreeNSI`, которая, в свою очередь вызывает соответствующее  событие на клиенте. При завершении работы клиента, он отписывается от сервиса, тем самым прекращая отсылку информации в свой адрес. Таким образом нагрузка с `SQL сервера` снимается.

Для удаления элемента справочника также используется хранимая процедура. Прежде всего, она предусматривает проверку на наличие ссылок на удаляемый элемент в данных других задач. Для осуществления этого, каждая задача, использующая данные `TreeNSI` описывается в специальной таблице. На стороне БД такой задачи, создается определенная хранимая процедура, которую и запускает процедура удаления на основании данных из таблицы описания сторонних задач. Если хранимая процедура на стороне БД клиента находит ссылки на удаляемый элемент, удаление элемента становится невозможным. Инициализация удаления происходит только от пользователя с необходимыми правами и только из интерфейса самого `TreeNSI`.

## Структура TreeNSI

Структура TreeNSI построена на следующих принципах:

1. [Древовидные справочники](#древовидные-справочники).
2. [Периодические значения реквизитов справочников](#периодические-значения-реквизитов-справочников).
3. [Единый каталог регистрации](#единый-катаnог-регистрации).

### Древовидные справочники

Большинство справочников системы имеют древовидную структуру. Наличие единого общего родителя для всех элементов справочника не является обязательным. Любой элемент или группа справочника может принадлежать либо не принадлежать другой группе. Также любая группа может иметь в своем составе другие группы и элементы либо нет (являться пустой). Каждый элемент группы или подгруппа унаследует от своего родителя его основные свойства, как правило более глубокое вложение описывает объект более детально. Для использования в качестве объектов документов подходит как группа, так и элементы – разница заключается только в степени детализации информации об объекте.

Для организации структуры подчиненности используются два реквизита:

`IdParent` – код группы-родителя;

`IsGroup` – признак группы (для элемента это `false`).

::: tip
Последний реквизит может показаться избыточным, однако благодаря ему намного упрощается валидация при вводе и редактировании данных.
:::

::: tip
Пример:

```
├── Суша
│    └── Лес
│         └── Деревья
│         └── Кустарники
│              └── Малина
│    └── Пустыня
├── Океан
```

Для группы `Лес` группой-родителем является группа `Суша`. Для элемента `Малина` - группа `Кустарники`. Соотвественно сразу понятно, что малина является кустарником, произростающем в лесном массиве на суше и никак не в пустыне.
:::

### Периодические значения реквизитов справочников

В реальной жизни постоянно происходит изменение окружающей среды: смена времени суток, времен года, погоды, климата и т.д. Нет почти  ни одного бизнес-объекта, который не подвергался бы каким-то изменениям. Казалось бы, такие “нерушимые” объекты, используемые в бизнес-логике современного предприятия как страны, только за последние 20 лет претерпели достаточно много изменений. Меняются названия населенных пунктов, столиц государств, реквизиты предприятий и многое другое.

Очень важно определить, когда происходит изменения какого-то свойства объекта, а когда создается новый. Наиболее простой вариант ее решения – постоянное добавление новых элементов, ведет к задвоению данных. Так как необходимо верно отображать информацию прошлых периодов, то удалять устаревшую информацию нельзя, в то же время при вводе новой, у пользователю приходится во время ввода сравнивать уже имеющуюся информацию с актуальной, решая нужен ли новый элемент. Соответственно это ведет к ошибкам ввода и задвоению.

Для отображения изменяемых во времени свойств объектов применяются периодические значения реквизитов справочников. Принцип прост: значение реквизита описывает свойство объекта начиная с определенного периода. Если свойство объекта изменяется, то реквизит получает новое значение, которое действительно с нового периода. Соответственно, для того, чтобы узнать актуальное значение реквизита на указанную дату, необходимо найти такое значение реквизита, у которого дата начала действия была бы максимально приближена, но меньше  указанной даты либо ей равна.

::: tip
Подобный принцип прекрасно показал себя еще в `1С-Предприятие` версии 7.7.
:::

В БД периодические реквизиты хранятся в отдельной таблице со следующей структурой:

`IdProperty` – ключ записи истории (автоинкрементное поле).

`IdElement` – ключ записи объекта справочника, чьи реквизиты описываются (обязателен для заполнения).

`BeginDate` – дата начала действия значения (обязательно для заполнения).

#### Значения реквизитов

Для ускорения обработки данных, иногда следует группировать схожие по смыслу периодические реквизиты в отдельные таблицы, так что для одного справочника может быть несколько таблиц с периодическими реквизитами.

Если описываемая сущность с определенного момента прекращает свое существование (например, предприятие ликвидировано), то для указания этого момента в структуру таблицы с периодическими значениями реквизитов добавляется вспомогательное поле `IsActive`. Это битовое поле в основном содержит значение `true`, и лишь значение `false` на определенную дату указывает на то, что с этой даты значения элемента справочника не актуальны (остальные значения реквизитов переносятся с предыдущей записи).

::: tip
Конечно, такая структура справочников усложняет работу с их данными. Что бы получить актуальное значение на указанную дату придется использовать достаточно сложный запрос. По этому для отображения данных широко используются представления `SQL`. Обычно весь список записей из справочника используется либо при редактировании самого справочника либо при вводе на клиентском приложении документов, использующих этот справочник. В обоих случаях интерес представляет актуальные на текущий (рабочий) момент времени значения реквизитов. Представления, используя в качестве даты актуальности функцию `T-SQL`  `GetDate()`, быстро отбирают необходимые актуальные значения и предоставляют их клиенту.
:::

Если редактируется документ с прошедшей датой, то без помощи процедур и функций `T-SQL` не обойтись – необходимо указать дату редактируемого документа для выборки актуальной на этот монет времени данных.

::: tip
Конечно, это не так гибко и удобно, как использование представлений, однако и  можно пойти на небольшую хитрость: обычно для выбора в форме редактирования данных из справочника необходимо минимум полей (в основном Наименование, Код – т.е. тех полей которые однозначно идентифицируют  запись), так что периодические значения заведомо в списках выбора не нужны. Но практика показывает, что предприятие или продукция может незначительно, но менять свое наименование, так что для таких справочников наименования необходимо делать периодическими реквизитами.

Для того, что бы разрешить эту проблему нужно немного углубиться в суть вопроса. Предприятие может поменять свое наименование (компания LG Electronics Inc. до 2005 года имела название GoldStar Electonics). Но в основном меняется название не так кардинально, обычно меняется аббревиатуры, означающие формы собственности (Публичное акционерное общество «Сбербанк России» ранее назывался Акционерный коммерческий Сберегательный банк Российской Федерации (ОАО)). То есть меняется полное наименование предприятия, тогда как его краткое наименование почти всегда остается прежним. Показывать длинные, многословные  полные наименования в формах выбора значения из справочника не только неудобно, но и ресурсоемко. Поэтому для подобных справочников добавляется в основную таблицу (где хранится ключ объекта) служебное поле `Name`. В него вносится краткое уникальное имя для предприятия без аббревиатур и лишних слов. Оно будет отображаться в списках в редакторах (поиск по такому полю эффективнее), в отчетах, тогда как на печать будет выводиться официальное актуальное полное наименование (для печати лишняя секунда для выборки данных через процедуры и функции не столь принципиальна, как для набора информации).
:::

Если же в форме редактирования документа после выбора элемента справочника запускается механизм дальнейшего автозаполения, который зависит от какого-то периодического реквизита выбранного элемента, то получить все необходимые данные, включая периодические, по имеющемуся ключу выбранного элемента и даты не составит труда. Это намного быстрее и дешевле, чем получать необходимые данные сразу из списка выбора элементов.

### Единый каталог регистрации

Единое НСИ предприятия подразумевает, что все результирующие данные с различных программ, в конце концов, будут обрабатываться в среде одной задачи. Обычно такая задача тесно связана с бухгалтерским учетом, ибо ее цель отобразить, прежде всего, финансовый результат деятельности предприятия. Разработчикам подобной системы приходится решать много различных задач по сведению разнородных данных из разных источников, что бы впоследствии "разложить" их по необходимым таблицам, обработать и записать результаты.

::: tip
Встает вопрос о том, как хранить обработанную информацию. Напрашивается решение, разделить каждое обрабатываемое направление деятельности по модулям, которые будут иметь свои таблицы хранения информации в БД: учет материалов, расчеты с поставщиками, расчеты с покупателями, расчеты с персоналом и т.д. Получается, что таблицы в БД для каждого модуля будут различными, а значит, и методы чтения-записи в них тоже будут разниться от модуля к модулю. Реализовывать множество интерфейсов чтения-записи данных весьма накладно. При более подробном рассмотрении оказывается, что таблицы хранения отличаются от модуля к модулю в основном полями, куда записываются идентификаторы элементов справочников, являющимися объектами учета или группировки. Если бы каждый элемент НСИ имел свой уникальный `ID`, то все таблицы для хранения результатов деятельности были бы схожей структуры, а, значит, для всех них необходим был бы один интерфейс  чтения-записи данных.

Еще один пример: расходная накладная. В качестве получателя груз может выступать как юридическое лицо (предприятие), так и физическое лицо, так и структурное подразделение предприятия-отправителя. Вносить в справочник контрагентов физических лиц (а именно так в большинстве случаев ранее и решалась эта проблема) ошибочно, добавлять в состав таблицы хранения данных новые поля для каждого типа получателя  - накладно и нецелесообразно. Гораздо проще организовать дополнительный справочник получателей, объединяющий различные типы сущностей в одну и присваивающий записи уникальный `ID`, который и использовать потом в качестве грузополучателя. Если идти таким путем, то подобный справочник нужен и для поля грузоотправитель, и для поля плательщик. Неудобство этого подхода в том, что для каждого нового грузополучателя (грузоотправителя)  необходимы дополнительные действия по его созданию (или до записи или во время записи данных о шапке накладной), что не очень удобно. Намного удобней было бы иметь уникальный ключ для любого элемента любого справочника сразу при его создании.
:::

Подобный подход не нов. Та же концепция уже использовалась в `1C-Предприятие`, `Галактика`, где в качестве ресурса в регистре можно было указать справочник неопределенного типа. Именно по такому принципу построен каталог регистрации и в TreeNSI.

В таблицу добавляются записи о дате и времени создания нового элемента (дата регистрации), его типа (отдельный служебный справочник в системе, где описаны все регистрируемые справочники системы) и код пользователя , выполнившего регистрацию. Основными колонками являются инкрементный ключ и тип справочника, элемент которого регистрируется. Регистрация происходит до записи самого элемента, полученный `ID` регистрации записывается в обязательным для заполнения  поле `IdCatalog` таблицы справочника. Если регистрация по каким-то причинам не прошла, то запись нового элемента будет невозможна. Весь механизм регистрации осуществляется через процедуры `T-SQL`, что является еще одной причиной использования хранимых процедур для ввода новых элементов справочников: если инициализация нового элемента происходит из сторонней задачи, то использование хранимый процедуры гарантирует, что все этапы создания нового элемента будут выполнены. Если же возникла ошибка при записи данных в таблицу справочника, то отдельная процедура отменит регистрацию – удалит запись из каталога регистрации.

Когда зарегистрированный элемент удаляется, удаляется и его регистрация в каталоге. Ссылку на зарегистрированный элемент в базе данных на ином сервере проще найти – процедура выполняющая поиск обращается к представлению, которое "собирает" `ID` регистрации используемых в БД элементов справочников, и ищет по переданному ей коду регистрации элемента.

Поля каталога `Дата регистрации` и `Код пользователя`, осуществившего регистрацию – служебные. Дата регистрации предоставляет общую для всех регистрируемых элементов сортировку, а код пользователя – минимум логирования (полезно, если по какой-то причине нет общей системы логирования).

::: tip
Следует отметить, что не все справочники системы подлежат регистрации. Справочники, данные которых регламентируются нормативными актами, служебные справочники регистрации не подлежат (Единицы измерения, Страны мира, Валюты). Но если же ведение учета подразумевает группировку и обработку данных по таким справочникам, то тогда в таблицу добавляется поле `IdCatalog`, в таблицу с типами справочников делается соответствующая запись и создается хранимая процедура создания элементов.
:::

Так же в каталоге можно регистрировать элементы справочников не входящих в систему TreeNSI.

::: tip
Например, для нужд определенной задачи нужно описать документ, в котором плательщиком может являться как юридическое лицо, так и сотрудник предприятия. Справочник сотрудников ведется в задаче кадрового учета и расположен на сервере, от сервера текущей задачи. Регистрация всех сотрудников в принципе не нужна, нужны лишь единицы из тысячи. Поэтому задача, описывающая такой документ, посылает запрос на регистрацию конкретного элемента справочника Сотрудники через хранимую процедуру в БД с кадровой информацией. Эта процедура обращается к процедуре регистрации в базе TreeNSI указывая тип справочника (Сотрудники) и код пользователя ее вызвавшего (из задачи учета оформления документа). Получив `ID` регистрации, хранимая процедура заполняет поле  `IdCatalog`  в таблице Сотрудники. Инициатор регистрации через представление сразу получает необходимый код для использования в своем документе.
:::

Единый код регистрации элементов также позволяет создавать новые справочники, состоящие из элементов других справочников. В качестве примера см. раздел "Структура предприятия".
